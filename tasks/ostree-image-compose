#!/bin/sh
set -xeuo pipefail

if [ "${branch}" = "master" ]; then
    branch="rawhide"
fi

# Find the base dir
base_dir="$(dirname $0)/.."
HOMEDIR=$(pwd)
rm -rf ${HOMEDIR}/output
mkdir -p ${HOMEDIR}/output
ln -fs ${HOMEDIR}/output ${HOMEDIR}/logs

if [ "$(sudo docker images | grep rsync-container)" == "" ]; then
    pushd $base_dir/config/Dockerfiles/rsync
    sudo docker build -t rsync-container .
    popd
fi

if [ "$(sudo docker images | grep ostree_image_compose-container)" == "" ]; then
    pushd $base_dir/config/Dockerfiles/ostree_image_compose
    sudo docker build -t ostree_image_compose-container .
    popd
fi

sudo docker run --privileged --cap-add=SYS_ADMIN -v ${HOMEDIR}/output:/home/output -e rsync_paths="netinst ostree images" -e rsync_from="fedora-atomic@artifacts.ci.centos.org::fedora-atomic/${branch}/" -e rsync_to="/home/output/" -e RSYNC_PASSWORD="$RSYNC_PASSWORD" rsync-container

sudo docker run --privileged -e 'container=docker' -v /sys/fs/cgroup:/sys/fs/cgroup:rw -v ${HOMEDIR}/output:/home/output -e branch="${branch}" -e RSYNC_PASSWORD="$RSYNC_PASSWORD" ostree_image_compose-container

# Logs need to be in a specific place to be picked up.
sudo mv ${HOMEDIR}/output/logs ${HOMEDIR}

sudo docker run --privileged --cap-add=SYS_ADMIN -v ${HOMEDIR}/output:/home/output -e rsync_paths="images" -e rsync_to="fedora-atomic@artifacts.ci.centos.org::fedora-atomic/${branch}/" -e rsync_from="/home/output/" -e RSYNC_PASSWORD="$RSYNC_PASSWORD" rsync-container
